---
title: "Main analysis"
author: "Jae Yeon Kim"
date: "`r Sys.Date()`"
output:
  word_document: default
  pdf_document:
    number_sections: yes
    fig_caption: yes
latex_engine: xelatex
link-citations: yes
linkcolor: blue
subparagraph: yes
citecolor: blue
urlcolor: blue
---

# Import pkgs and data 

```{r}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

# install pkgs

if (!require(pacman)) install.packages("pacman")

pacman::p_load(
  tidyverse,
  glue,
  purrr,
  broom,
  patchwork,
  here,
  estimatr, 
  ggrepel,
  modelsummary, 
  marginaleffects,
  tidyhte, 
  fixest,
  glmnet,
  # text analysis
  tidytext,
  readtext,
  quanteda, 
  keyATM,
  stm
)

ggplot2::theme_set(theme_minimal())

if (!require(stdidx)) devtools::install_github("graemeblair/stdidx")
library(stdidx)

if (!require(tidyhte)) devtools::install_github("ddimmery/tidyhte")
library(tidyhte)

source(here("functions", "utils.R"))

# raw data
df_string <- read_csv(here("raw_data", "HARV0049_OUTPUT_strings.csv"))
df_numeric <- read_csv(here("raw_data", "HARV0049_OUTPUT_numeric.csv"))

# processed data (content analysis)
coded_text <- read_csv(here("processed_data", "coded_text_JYK.csv"))
```

# Data summary 

## Categorical 

```{r}
datasummary_skim(df_string %>%
                   select(nat_origin, immigrant), 
                 type = "categorical",
                 output = here("outputs", "cat_data_summary.docx"))
```

## Numeric 

```{r}
df_num_sumamry <- create_dummies(df_numeric) %>%
  select(chinese_origin, immigrant, DEM, GOP, college, female, age)

df_num_sumamry$hate_crime_treatment <- df_string$hate_crime_treatment

datasummary(All(df_num_sumamry) ~ hate_crime_treatment * (mean_no_na + std_no_na),
            data = df_num_sumamry, 
            output = here("outputs", "balance.docx"))
```

# ATE

```{r}
estimate_ate <- function(dv) {
  out <- lm_robust(eval(as.symbol(dv)) ~ factor(hate_crime_treatment), data = df_numeric) %>%
    tidy() %>%
    filter(!str_detect(term, "Int")) %>%
    mutate(outcome = dv)
  
  return(out)
}

ate_outs <- purrr::map_dfr(list("chinese_virus", "racial_linked_fate", "ethnic_linked_fate", "asian_racial_id", "asian_ethnic_id", "affirmative_action", "policy_crime"), estimate_ate) %>%
  mutate(term = case_when(
    str_detect(term, "4") ~ "Hate crime + political representation", 
    str_detect(term, "3") ~ "Hate crime + China threat", 
    str_detect(term, "2") ~ "Hate crime"
  )) 
```

## Linked fates 

```{r}
ate_outs %>% 
  filter(str_detect(outcome, "linked")) %>%
  mutate(outcome = case_when(
    str_detect(outcome, "racial") ~ "Racial linked fate", 
    str_detect(outcome, "ethnic") ~ "Ethnic linked fate"
  )) %>%
  ggplot(aes(x = term, y = estimate, ymax = conf.high, ymin = conf.low, col = outcome,
             label = round(estimate, 2))) +
  geom_pointrange(position = position_dodge(width = 0.4)) +
  coord_flip() +
  labs(
    title = "Linked fates",
    x = "", 
    y = "Estimated ATE",
    col = "Outcome") +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed")  +
  scale_color_grey(start = 0.3, end = 0.7) +
  geom_text_repel(position = position_dodge(width = 0.4)) 

ggsave(here("outputs", "lf_plots.png"), 
       height = 6, 
       width = 8)
```

```{r}
lf_mods <- list(
  "Ethnic linked fate" = feols(ethnic_linked_fate ~ factor(hate_crime_treatment), data = df_numeric, vcov = "hetero"),
  "Ethnic linked fate (weighted)" = feols(ethnic_linked_fate ~ factor(hate_crime_treatment), data = df_numeric, weights = ~weight, vcov = "hetero"),
  "Racial linked fate" = feols(racial_linked_fate ~ factor(hate_crime_treatment), data = df_numeric, vcov = "hetero"),
  "Racial linked fate (weighted)" = feols(racial_linked_fate ~ factor(hate_crime_treatment), data = df_numeric, weights = ~weight, vcov = "hetero")

)

mad_cm <- c(
  "factor(hate_crime_treatment)4" = "Hate crime + political representation", 
  "factor(hate_crime_treatment)3" = "Hate crime + China threat", 
  "factor(hate_crime_treatment)2" = "Hate crime"
)

modelsummary(lf_mods,
             estimate = c("{estimate}{stars} \n [{conf.low}, {conf.high}] \n p = {p.value}"),
             statistic = NULL,
             coef_map = mad_cm,
             coef_omit = "Intercept",
             output = here("outputs", "lf_mods.docx"))
```

## Identity importance 

```{r}
ate_outs %>% 
  filter(str_detect(outcome, "_id")) %>%
  mutate(outcome = case_when(
    str_detect(outcome, "racial") ~ "Racial ID importance", 
    str_detect(outcome, "ethnic") ~ "Ethnic ID importance"
  )) %>%
  ggplot(aes(x = term, y = estimate, ymax = conf.high, ymin = conf.low, col = outcome,
             label = round(estimate, 2))) +
  geom_pointrange(position = position_dodge(width = 0.4)) +
  coord_flip() +
  labs(
    title = "ID importance",
    x = "", 
    y = "Estimated ATE",
    col = "Outcome") +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed")  +
  scale_color_grey(start = 0.3, end = 0.7) +
  geom_text_repel(position = position_dodge(width = 0.4)) 

ggsave(here("outputs", "id_plots.png"), 
       height = 6, 
       width = 8)
```

## Chinese virus 

```{r}
ate_outs %>% 
  filter(str_detect(outcome, "_virus")) %>%
  mutate(outcome = case_when(
    str_detect(outcome, "chinese") ~ "Chinese virus"
  )) %>%
  ggplot(aes(x = term, y = estimate, ymax = conf.high, ymin = conf.low,
             label = round(estimate, 2))) +
  geom_pointrange(position = position_dodge(width = 0.4)) +
  coord_flip() +
  labs(
    title = "Chinese virus",
    x = "", 
    y = "Estimated ATE") +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed")  +
  scale_color_grey(start = 0.3, end = 0.7) +
  geom_text_repel(position = position_dodge(width = 0.4)) 

ggsave(here("outputs", "cv_plot.png"), 
       height = 6, 
       width = 8)
```

## Policy outcomes

```{r}
ate_outs %>% 
  filter(str_detect(outcome, "action|crime")) %>%
  mutate(outcome = case_when(
    str_detect(outcome, "action") ~ "Affirmative action",
    str_detect(outcome, "crime") ~ "Police funding"
  )) %>%
  ggplot(aes(x = term, y = estimate, ymax = conf.high, ymin = conf.low, col = outcome,
             label = round(estimate, 2))) +
  geom_pointrange(position = position_dodge(width = 0.4)) +
  coord_flip() +
  labs(
    title = "Policy preferences",
    x = "", 
    y = "Estimated ATE",
    col = "Outcome") +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed")  +
  scale_color_grey(start = 0.3, end = 0.7) +
  geom_text_repel(position = position_dodge(width = 0.4)) 

ggsave(here("outputs", "policy_plots.png"), 
       height = 6, 
       width = 8)
```

# CATE

## Traditional approach

```{r}
# Chinese origin 
df_numeric$chinese_origin <- ifelse(df_numeric$nat_origin == 1, "Chinese", "Non-Chinese")

# Party ID
df_numeric$DEM <- ifelse(df_numeric$pid3 == 1 | df_numeric$pid7 %in% c(1, 3), "DEM", "Non-DEM")

df_numeric$GOP <- ifelse(df_numeric$pid3 == 3 | df_numeric$pid7 %in% c(7, 5), "GOP", "Non-GOP")

# Immigrant
df_numeric$immigrant <- ifelse(df_numeric$immigrant %in% c(1, 2), "Immigrant", "Non-immigrant")

# College
df_numeric$college <- ifelse(df_numeric$educ %in% c(3:6), "College", "Non-college")

# Male
df_numeric$female <- ifelse(df_numeric$gender4 == 2, "Female", "Else")
```

```{r}
# China threat index 
df_numeric$china_threat_index <- idx_mean(df_numeric$china_threat_1_rule, df_numeric$china_threat_2_rule, df_numeric$china_threat_3_rule)

df_numeric$china_threatend_high <- ifelse(df_numeric$china_threat_index > median(df_numeric$china_threat_index), "High", "Median and Low")

# Democracy conception
df_numeric$democracy_sub <- idx_mean(df_numeric$democracy_meaning_1 + df_numeric$democracy_meaning_2 + df_numeric$democracy_meaning_3)

df_numeric$democracy_cat <- ifelse(df_numeric$democracy_sub > median(df_numeric$democracy_sub), "High", "Median and Low")
```

```{r}
ols <- function(df, dv) { 
  
  lm_robust(eval(as.symbol(dv)) ~ factor(hate_crime_treatment), data = df) %>%
    tidy() %>%
    filter(!str_detect(term, "Int")) %>%
    mutate(outcome = dv)
  
}

nest_ols <- function(df, dv) {
  
  df %>%
    nest() %>%
    mutate(ols = map(data, ~ols(., dv))) %>%
    unnest(ols) %>% 
    mutate(term = case_when(
      str_detect(term, "4") ~ "Hate crime + political representation", 
      str_detect(term, "3") ~ "Hate crime + China threat", 
      str_detect(term, "2") ~ "Hate crime"
    )) %>%
    mutate(outcome = case_when(
      str_detect(outcome, "racial") ~ "Racial linked fate", 
      str_detect(outcome, "ethnic") ~ "Ethnic linked fate"
    ))  
}
```

```{r}
chinese_cate_plot <- bind_rows(
  df_numeric %>%
    group_by(chinese_origin) %>%
    nest_ols("racial_linked_fate"),
  df_numeric %>%
    group_by(chinese_origin) %>%
    nest_ols("ethnic_linked_fate")
  ) %>%
  ggplot(aes(x = term, y = estimate, ymax = conf.high, ymin = conf.low, col = chinese_origin,
             label = round(estimate, 2))) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  coord_flip() +
  labs(
    title = "Chinese v Non-Chinese",
    x = "", 
    y = "Estimated ATE",
    col = "Subgroup") +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed")  +
  scale_color_grey(start = 0.3, end = 0.7) +
  geom_text_repel(position = position_dodge(width = 0.2)) +
  theme(legend.position = "right") +
  facet_wrap(~outcome)

china_threat_perc_plot <- bind_rows(
  df_numeric %>%
    group_by(china_threatend_high) %>%
    nest_ols("racial_linked_fate"),
  df_numeric %>%
    group_by(china_threatend_high) %>%
    nest_ols("ethnic_linked_fate")
  ) %>%
  ggplot(aes(x = term, y = estimate, ymax = conf.high, ymin = conf.low, col = china_threatend_high,
             label = round(estimate, 2))) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  coord_flip() +
  labs(
    title = "Perceived China threat",
    x = "", 
    y = "Estimated ATE",
    col = "Subgroup") +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed")  +
  scale_color_grey(start = 0.3, end = 0.7) +
  geom_text_repel(position = position_dodge(width = 0.2)) +
  theme(legend.position = "right") +
  facet_wrap(~outcome)

dem_perc_plot <- bind_rows(
  df_numeric %>%
    group_by(democracy_cat) %>%
    nest_ols("racial_linked_fate"),
  df_numeric %>%
    group_by(democracy_cat) %>%
    nest_ols("ethnic_linked_fate")
  ) %>%
  ggplot(aes(x = term, y = estimate, ymax = conf.high, ymin = conf.low, col = democracy_cat,
             label = round(estimate, 2))) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  coord_flip() +
  labs(
    title = "Democracy perception",
    x = "", 
    y = "Estimated ATE",
    col = "Subgroup") +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed")  +
  scale_color_grey(start = 0.3, end = 0.7) +
  geom_text_repel(position = position_dodge(width = 0.2)) +
  theme(legend.position = "right") +
  facet_wrap(~outcome)

cate_rl_plots <- chinese_cate_plot / china_threat_perc_plot / dem_perc_plot + plot_annotation(tag_levels = "a")

cate_rl_plots

ggsave(plot = cate_rl_plots, 
       filename = here("outputs", "cate_rl_plots.png"), 
       height = 12, 
       width = 10)
```

## Double roubst learner

```{r}
# racial linked fate
t2_rl_results <- get_db_rl_estimates(2)
t3_rl_results <- get_db_rl_estimates(3)
t4_rl_results <- get_db_rl_estimates(4)

# ethnic linked fate
t2_el_results <- get_db_el_estimates(2)
t3_el_results <- get_db_el_estimates(3)
t4_el_results <- get_db_el_estimates(4)
```

```{r}
rl_results <- reduce(list(
  t2_rl_results %>%
    mutate(treatment = "Hate crime"), 
  t3_rl_results %>%
    mutate(treatment = "Hate crime + China threat"), 
  t4_rl_results %>%
    mutate(treatment = "Hate crime + political representation")), bind_rows) %>%
  mutate(outcome = "Racial linked fate")
```

```{r}
el_results <- reduce(list(
  t2_el_results %>%
    mutate(treatment = "Hate crime"), 
  t3_el_results %>%
    mutate(treatment = "Hate crime + China threat"), 
  t4_el_results %>%
    mutate(treatment = "Hate crime + political representation")), bind_rows) %>%
  mutate(outcome = "Ethnic linked fate")

results <- bind_rows(rl_results, el_results)
```

## Load 

```{r}
write_csv(results, here("processed_data", "cate_results.csv"))

results <- read_csv(here("processed_data", "cate_results.csv"))
```

## Pre-registered

```{r}
#chinese_origin, democracy_cat, china_threatend_high, DEM, GOP

cn_origin_plot <- results %>%
  filter(estimand == "MCATE") %>%
  filter(term == "chinese_origin") %>%
  ggplot(aes(x = treatment, 
             y = estimate, 
             ymin = estimate - 1.96 * std_error,
             ymax = estimate + 1.96 * std_error,
             col = level,
             label = round(estimate, 2))) +
  geom_text_repel(position = position_dodge(width = 0.2)) +
  facet_wrap(~outcome) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed") +
  scale_x_discrete("Covariate level") +
  scale_y_continuous("Estimated CATE") +
  labs(col = "Subgroup",
       title = "Marginal effects across Chinese dummy") +
  coord_flip() +
  scale_color_grey(start = 0.3, end = 0.7)

dem_pec_plot <- results %>%
  filter(estimand == "MCATE") %>%
  filter(term == "democracy_cat") %>%
  ggplot(aes(x = treatment, 
             y = estimate, 
             ymin = estimate - 1.96 * std_error,
             ymax = estimate + 1.96 * std_error,
             col = level,
             label = round(estimate, 2))) +
  geom_text_repel(position = position_dodge(width = 0.2)) +
  facet_wrap(~outcome) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed") +
  scale_x_discrete("Covariate level") +
  scale_y_continuous("Estimated CATE") +
  labs(col = "Subgroup",
       title = "Marginal effects across substantive democracy perception") +
  coord_flip() +
  scale_color_grey(start = 0.3, end = 0.7)

cn_threat_plot <- results %>%
  filter(estimand == "MCATE") %>%
  filter(term == "china_threatend_high") %>%
   ggplot(aes(x = treatment, 
             y = estimate, 
             ymin = estimate - 1.96 * std_error,
             ymax = estimate + 1.96 * std_error,
             col = level,
             label = round(estimate, 2))) +
  geom_text_repel(position = position_dodge(width = 0.2)) +
  facet_wrap(~outcome) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed") +
  scale_x_discrete("Covariate level") +
  scale_y_continuous("Estimated CATE") +
  labs(col = "Subgroup",
       title = "Marginal effects across perceived China threat") +
  coord_flip() +
  scale_color_grey(start = 0.3, end = 0.7)
```

## Non-registered

```{r}
pid_plot <- results %>%
  filter(estimand == "MCATE") %>%
  filter(term %in% c("DEM", "GOP")) %>%
  filter(!str_detect(level, "Non")) %>%
  ggplot(aes(x = treatment, 
             y = estimate, 
             ymin = estimate - 1.96 * std_error,
             ymax = estimate + 1.96 * std_error,
             col = level,
             label = round(estimate, 2))) +
  geom_text_repel(position = position_dodge(width = 0.2)) +
  facet_wrap(~outcome) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed") +
  scale_x_discrete("Covariate level") +
  scale_y_continuous("Estimated CATE") +
  scale_color_manual(values = c("blue", "red")) +
  labs(col = "Subgroup",
       title = "Marginal effects across party ID") +
  coord_flip() +
  theme(legend.position = "bottom")
```

```{r}
immigrant_plot <- results %>%
  filter(estimand == "MCATE") %>%
  filter(term == "immigrant") %>%
  ggplot(aes(x = treatment, 
             y = estimate, 
             ymin = estimate - 1.96 * std_error,
             ymax = estimate + 1.96 * std_error,
             col = level,
             label = round(estimate, 2))) +
  geom_text_repel(position = position_dodge(width = 0.2)) +
  facet_wrap(~outcome) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed") +
  scale_x_discrete("Covariate level") +
  scale_y_continuous("Estimated CATE") +
  labs(col = "Subgroup",
       title = "Marginal effects across immigrant status") +
  scale_color_grey(start = 0.3, end = 0.7) +
  coord_flip() +
  theme(legend.position = "bottom")

college_plot <- results %>%
  filter(estimand == "MCATE") %>%
  filter(term == "college") %>%
  ggplot(aes(x = treatment, 
             y = estimate, 
             ymin = estimate - 1.96 * std_error,
             ymax = estimate + 1.96 * std_error,
             col = level,
             label = round(estimate, 2))) +
  geom_text_repel(position = position_dodge(width = 0.2)) +
  facet_wrap(~outcome) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed") +
  scale_x_discrete("Covariate level") +
  scale_y_continuous("Estimated CATE") +
  labs(col = "Subgroup",
       title = "Marginal effects across college education status") +
  scale_color_grey(start = 0.3, end = 0.7) +
  coord_flip() +
  theme(legend.position = "bottom")
```

## Pooled 

```{r}
results_pooled <- results %>%
  filter(estimand == "MCATE")

results_pooled$level[results_pooled$term == "democracy_cat"] <- rep(c("Median and low democracy perception", "High democracy perception"), 6)

results_pooled$level[results_pooled$term == "china_threatend_high"] <- rep(c("Median and low China threat perception", "High China threat perception"), 6)
```

```{r}
pooled_cate_plot <- results_pooled %>%
  filter(!str_detect(level, "Non-G|Non-D")) %>%
  mutate(significant = ifelse(estimate - 1.96 * std_error > 0, "Significant", "Non-significant")) %>%
  ggplot(aes(x = fct_reorder(level, estimate), 
             y = estimate,
             ymin = estimate - 1.96 * std_error,
             ymax = estimate + 1.96 * std_error,
             label = round(estimate, 2), 
             col = significant)) +
  geom_pointrange(position = position_dodge(width = 0.2)) +
  geom_text_repel(position = position_dodge(width = 0.2)) +
  coord_flip() +
  facet_grid(outcome~treatment) +
  geom_abline(intercept = 0, slope = 0, linetype = "dashed") +
  labs(x = "",
       y = "Estimated CATE",
       col = "Statistical significance") +
  theme(legend.position = "bottom") +
  scale_color_grey(start = 0.7, end = 0.3) 

pooled_cate_plot
```

## Save

```{r}
hte_plots <- cn_origin_plot / cn_threat_plot / dem_pec_plot + plot_annotation(tag_levels = "a")

png(filename = here("outputs", "hte_plots.png"), 
    height = 12, 
    width = 10, 
    unit = "in", 
    res = 1200)

hte_plots 

dev.off()
```

```{r}
png(filename = here("outputs", "hte_plots_pid.png"), 
    height = 6, 
    width = 6, 
    unit = "in", 
    res = 1200)

pid_plot 

dev.off()
```

```{r}
hte_plots_others <- immigrant_plot / college_plot + plot_annotation(tag_levels = "a")

png(filename = here("outputs", "hte_plots_others.png"), 
    height = 12, 
    width = 10, 
    unit = "in", 
    res = 1200)

hte_plots_others

dev.off()
```

```{r}
png(filename = here("outputs", "pooled_cate_plot.png"), 
    height = 12, 
    width = 10, 
    unit = "in", 
    res = 1200)

pooled_cate_plot

dev.off()
```

# Open-ended texts

## Descriptive statitics 

```{r}
my_stop_words <- bind_rows(stop_words, 
                           tibble(word = c("asian", "asians", "american", "americans"),
                                  lexicon = rep("custom", 4)))

# succeed, fail are frequent words

df_string %>%
  unnest_tokens(word, asian_open_ended_question) %>%
  anti_join(my_stop_words) %>%
  count(hate_crime_treatment, word, sort = TRUE) %>%
  head(n = 30) 

df_string_word_pct <- df_string %>%
  mutate(succeed = ifelse(str_detect(tolower(asian_open_ended_question), "succeed"), 1, 0)) %>%
  mutate(fail = ifelse(str_detect(tolower(asian_open_ended_question), "fail"), 1, 0)) %>%
  select(hate_crime_treatment, succeed, fail)

datasummary(All(df_string_word_pct) ~ hate_crime_treatment * (mean_no_na + std_no_na),
            data = df_string_word_pct,
            output = here("outputs", "balance_word_pct.docx"))
```

## Content analysis

```{r}
coded_text <- coded_text %>%
  mutate(unsure = ifelse(is.na(asian_open_ended_question), NA, unsure))

coded_text <- coded_text %>%
  replace_na(list(unsure = 0, succeed = 0, fail = 0, contingent = 0, misread = 0)) %>%
  mutate(validate = unsure + succeed + fail + contingent + misread) 

coded_text %>%
  filter(validate > 1) # this should be zero
```

```{r}
coded_text %>%
  filter(!is.na(asian_open_ended_question)) %>% # n = 1,878, 94% response rate 
  filter(misread == 0) %>%
  pull(fail) %>%
  mean()

coded_text %>%
  filter(!is.na(asian_open_ended_question)) %>% # n = 1,878, 94% response rate 
  filter(misread == 0) %>% # n = 1,636
  group_by(hate_crime_treatment) %>%
  summarize(unsure_rate = mean(unsure), 
            succeed_rate = mean(succeed), 
            fail_rate = mean(fail), 
            contingnet_rate = mean(contingent)) %>%
  pivot_longer(matches("rate")) %>%
  mutate(name = case_when(
    str_detect(name, "unsure") ~ "Unsure", 
    str_detect(name, "succeed") ~ "Succeed",
    str_detect(name, "fail") ~ "Fail",
    str_detect(name, "conti") ~ "Contingent"
  )) %>%
  ggplot(aes(x = hate_crime_treatment, y = value)) +
  geom_col() +
  geom_errorbar(aes(ymin = value - 1.96 * sd(value) / sqrt(length(value)),
                    ymax = value + 1.96 * sd(value) / sqrt(length(value))),
                position = position_dodge(width = 0.4)) +
  geom_text(aes(label = paste0(round(value, 2)*100, "%")), nudge_y = 0.12) +
  facet_wrap(~name) +
  coord_flip() +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "", 
       y = "Proportion of the responses",
       title = "Content analysis of open-ended responses",
       subtitle = "Excluding non- and misread-responses (n = 1,636)")

ggsave(here("outputs", "content_analysis.png"))
```

## keyATM

### Preprocess

```{r}
corpus <- coded_text %>%
  filter(!is.na(asian_open_ended_question)) %>% # n = 1,878, 94% response rate 
  filter(misread == 0) %>% # n = 1,636
  filter(fail == 1) %>%
  mutate(text = clean_text(asian_open_ended_question))
```

```{r}
key_corpus <- quanteda::corpus(corpus$text)

docvars(key_corpus, "hate_crime_treatment") <- corpus$hate_crime_treatment
```

```{r}
# Tokenize 
data_tokens <- tokens(key_corpus) 
```

### Document-term matrix

```{r}
data_dfm <- dfm(data_tokens) 
```

### KeyATM

```{r}
keyATM_docs <- keyATM_read(texts = data_dfm)

keywords <- list(
    
    "diverisy" = c("language", "culture", "history", "generation", "east", "south", "chinese", "indian", "japanese", "filipino", "korean", "class", "privilege", "agenda", "competition", "fight", "internal"),
    
    "political_agency" = c("assert", "voice", "silent", "stay", "vote", "participate", "leader"),
    
    "outside_support" = c("support", "resource", "media", "funding", "government", "white")
    
    )

key_viz <- visualize_keywords(docs = keyATM_docs, 
                              keywords = keywords)

key_viz

save_fig(key_viz, here("outputs", "keyword.png")) 
```

```{r}
# run many models 
many_models <- tibble(K = c(3:5)) %>%
               mutate(topic_model = map(K, ~stm(data_dfm, K = .)))

write_rds(many_models, here("outputs", "many_models.rds"))

#many_models <- read_rds(here("outputs", "many_models.rds"))
```

```{r}
k_search_diag <- visualize_diag(data_dfm, many_models)

ggsave(here("outputs", "k_search_diag.png"))
```

#### Static topic modeling 

```{r}
set.seed(1234)

out <- keyATM(docs = keyATM_docs,       # text input
              no_keyword_topics = 1,    # number of topics without keywords
              keywords = keywords,      # keywords
              model = "base",           # select the model
              options = list(seed = 250,
              store_theta = TRUE))

write_rds(out, here("outputs", "keyATM_out.rds"))

#out <- read_rds(here("outputs", "keyATM_out.rds"))

# theta = document-topic distribution 
out$theta <- round(out$theta, 0)

# sum 
sums <- c(sum(out$theta[,1]), sum(out$theta[,2]), sum(out$theta[,3]))
```

```{r}
topic_out <- tibble(topic_sums = sums,
                    names = c("Diversity", "Political agency", "Outside support")) %>%  
           mutate(prop = topic_sums / sum(topic_sums),
           prop = round(prop, 2))

topic_out %>% 
    ggplot(aes(x = fct_reorder(names, prop), y = prop)) +
    geom_col(position = "dodge") +
    scale_y_continuous(labels =    
    scales::percent_format(accuracy = 1)) +
    labs(x = "Topic name", 
         y = "Topic proportion",          
         title = "Topic-document distributions",
        subtitle = "Responses mentioned the reasons on why Asian Americans would fail to unite (n = 806)") +
   geom_text(aes(label = paste0(round(prop, 2)*100, "%")), nudge_y = 0.05) 

ggsave(here("outputs", "topic_modeling_static.png"))
```

#### Covariate topic modeling 

```{r}
# Extract covariates 
vars <- docvars(key_corpus)

vars_selected <- vars %>%
  select(hate_crime_treatment) %>%
  mutate(treatment = factor(hate_crime_treatment))

# Topic modeling 
covariate_out <- keyATM(docs = keyATM_docs,       # text input
              no_keyword_topics = 1,    # number of topics without keywords
              keywords = keywords,      # keywords
              model = "covariates",           # select the model
              model_settings = list(covariates_data = vars_selected,
                                    covariates_formula = ~ treatment),
              options = list(seed = 250, store_theta = TRUE))

covariates_info(covariate_out)
```

```{r}
# Predicted mean of the document-term distribution for intervention 
strata_topic_t1 <- by_strata_DocTopic(covariate_out, by_var = "treatmentHate Crime",
                                   labels = c("Control", "Hate Crime"))

strata_topic_t2 <- by_strata_DocTopic(covariate_out, by_var = "treatmentHate Crime + China Threat",
                                   labels = c("Control", "Hate Crime + China threat"))

strata_topic_t3 <- by_strata_DocTopic(covariate_out, by_var = "treatmentHate Crime + Political Representation",
                                   labels = c("Control", "Hate Crime + Political representation"))
```

```{r}
reduce(list(strata_topic_t1$tables$`Hate Crime`,
strata_topic_t2$tables$`Hate Crime + China threat`,
strata_topic_t3$tables$`Hate Crime + Political representation`), 
  bind_rows) %>%
  filter(TopicID != 4) %>%
  rename(Label = label) %>%
  ggplot(aes(x = Label, 
             y = Point, 
             ymin = Lower, 
             ymax = Upper,
             label = round(Point, 2))) +
  geom_pointrange() +
  facet_wrap(~Topic) +
  coord_flip() +
  geom_text(nudge_x = 0.1) +
  labs(x = "", y = "Marginal posterior mean of document-topic distribution")

ggsave(here("outputs", "covariate_topic_modeling.png"))
```